---
title: "Stat 706 Final Project: Investigating Predictors of Movie Profitability"
subtitle: Nickhil Sethi
output:
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
library(dplyr)

# global variable, don't want to echo this
GENRE_COLUMNS <- c("genre_vision_view_entertainment", "genre_thriller", "genre_pulser_productions", "genre_war", "genre_fantasy", "genre_documentary", "genre_sentai_filmworks", "genre_gohands", "genre_action", "genre_mardock_scramble_production_committee", "genre_family", "genre_crime", "genre_comedy", "genre_foreign", "genre_adventure", "genre_telescene_film_group_productions", "genre_mystery", "genre_science_fiction", "genre_horror", "genre_drama", "genre_carousel_productions", "genre_rogue_state", "genre_the_cartel", "genre_animation", "genre_romance", "genre_western", "genre_aniplex", "genre_history", "genre_brosta_tv", "genre_tv_movie", "genre_odyssey_media", "genre_music")

CSV_FILE_PATH <-  "/Users/nickhilsethi/src/stat706-class-materials/final-project/terraform/project-infra/project_data.csv"

```
# TODO
- Run plots of relevant variables against revenue. covariance matrix of genres.
- Run regression using step function AIC information criterion. Identify meaningful values using  p-values.
- Discuss the results. Run diagnostics, were the assumptions of LR correct?
- Prediction intervals

# Introduction
Profitability has become a contentious subject in the film industry in recent years. Acclaimed director G. Inarritu likened the state of affairs of the industry "the 99% and the 1%" of the global economy (https://youtu.be/SQ7qKKQrSBY), with the highest grossing films being either remakes of one kind or another (e.g. Marvel, Star Wars), or very small-budget independent films that receive high critical praise (e.g. Moonlight, Birdman, etc.).

The goal of this paper is to empirically determine predictors of the profitability of a film using Kaggle's ["The Movies Dataset"](https://www.kaggle.com/rounakbanik/the-movies-dataset), an aggregate of data from GroupLens and TMDB, containing data on film revenue, budget, genre, and ratings. 

We begin from a complete set of predictors (see below) and use an iterative procedure to minimize the Akaike-Information Criterion (i.e. R's `step` function) in order to discover the most relevant variables.

- Release date. This allows us capture some kind of time-trend in profitability
- Budget. This captures the constraint that movies must be generally profitable. 
- Genre. This captures popularity effects by genre.
- Rating. This captures the critical-reception of the film.

# Methods

## Data
The Movies dataset contains three tables relevant to our analysis -- `movies_metadata`, `ratings`, and a join table `links`. The three tables have the following schemas:

```
MOVIES_METADATA {
  genres: [{ genreId: <int>,  name: <str>}],
  revenue: float,
  budged: float,
  imdbId: int
}

RATINGS {
  movieId: int,
  userId: int,
  rating: float,
}

LINKS {
  movieId: int,
  imdbId: int
}
```
### Data Transformation and Cleaning

Some preparation was needed to turn these three tables into a usable format. The genre column of `movies_metadata` is JSON, encoded as a list of pairs representing the set of genres the film is associated with e.g. `[{genreId: 1, genreName: Action}, {genreId: 2, genreName: Comedy}]`; this column was converted to a set of boolean columns e.g. `genre_action` with `True` representing that the film belongs to that genre.

The `ratings` table contains movie ratings at the level of `(movieId, userId)` pairs, i.e. at the level of an individual critic's review; a grouping operation was performed to compute the average rating for each movie. Finally, a join was performed between the two tables using the join table `links` to create a single `movies` table, which serves as the final dataset on which we run our regression.

The `movies` schema is described below. The `profit`column is a derived quantity defined as `revenue - budget`; note the assumption here that all films use exactly there budget. The table also contains 32 genre columns with naming pattern `genre_[name]`; the prefix of "genre_" helps to avoid unfortunate name conflicts with keywords in postgres and python e.g. foreign (as in foreign key).

```
movies {
  imdb_id: int,
  revenue: float,
  budget: float,
  profit: float,
  release_date: date,
  genre_action: boolean,
  genre_thriller: boolean,
  ...
  genre_music: boolean
}
```

Finally, rows with missing values are dropped. As can be seen from the chart below, the variable `is_complete` may be correlated with revenue, with incomplete rows typically having `0` profit, but this is not a major conceptual issue for the project for two reasons; first, the vast majority of the films in the dataset are roughly break even.


```{r}
movies <- read.csv(file = CSV_FILE_PATH, header = TRUE, sep = ",")

# compute profits for each film
movies$profit <- movies$revenue - movies$budget

# cast the release_date field to a date type
movies$release_date <- as.Date(movies$release_date)

# cast genre columns to boolean
for (col in GENRE_COLUMNS) {
  movies[col] <- lapply(movies[col], as.logical)
}

# check if completeness is 
movies$is_complete <- complete.cases(movies)
ggplot(movies, aes(x=is_complete, y=profit)) + geom_jitter(width = .05, height=.05) + geom_point()

num_non_profitable <- nrow(movies[movies$profit < 0.1 && -0.1 < movies$profit,])
num_non_profitable

num_profitable <-  nrow(movies[movies$profit > 100,])
num_profitable

movies <- movies[movies$profit > 100,]

# confirm that NA is not correlated with revenue
movies <- movies[movies$is_complete == TRUE, ]

# subsample 20% of the data
# movies <- movies[sample(nrow(movies), nrow(movies) / 2), ]
```

### General Characteristics and Distribution

First, let's take a look at the distribution of profit. It seems profit is approximately a gaussian variable, heavily peaked at zero, with a fraction of films being either profit positive or profit negative:
```{r}
ggplot(movies, aes(x=profit)) + geom_histogram(bins=100)
```

```{r}
ggplot(movies, aes(x=budget, y=profit)) + geom_point()
```

Ratings appear to have some effect on profitability, but as we can clearly see the relationship is non-linear:
```{r}
ggplot(movies, aes(x=average_rating, y=profit)) + geom_point()
```


Release date has an interesting relationship with profit;
```{r}
ggplot(movies, aes(x=release_date, y=profit)) + geom_point()
```

## Model

```{r}
lmod <- lm(profit ~ budget + average_rating + release_date + genre_vision_view_entertainment + genre_thriller + genre_pulser_productions + genre_war + genre_fantasy + genre_documentary + genre_sentai_filmworks + genre_gohands + genre_action + genre_mardock_scramble_production_committee + genre_family + genre_crime + genre_comedy + genre_foreign + genre_adventure + genre_telescene_film_group_productions + genre_mystery + genre_science_fiction + genre_horror + genre_drama + genre_carousel_productions + genre_rogue_state + genre_the_cartel + genre_animation + genre_romance + genre_western + genre_aniplex + genre_history + genre_brosta_tv + genre_tv_movie + genre_odyssey_media + genre_music, data = movies)
lmod_reduced <- step(lmod, echo=FALSE)
summary(lmod_reduced)
```


# Discussion

## Challenges
Not robust to re-sampling. Co-linearity between genres
