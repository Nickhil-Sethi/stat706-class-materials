---
title: "Stat 706 Final Project: Investigating Predictors of Movie Profitability"
subtitle: Nickhil Sethi
output:
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)

# global variable, don't want to echo this
GENRE_COLUMNS <- c("genre_vision_view_entertainment", "genre_thriller", "genre_pulser_productions", "genre_war", "genre_fantasy", "genre_documentary", "genre_sentai_filmworks", "genre_gohands", "genre_action", "genre_mardock_scramble_production_committee", "genre_family", "genre_crime", "genre_comedy", "genre_foreign", "genre_adventure", "genre_telescene_film_group_productions", "genre_mystery", "genre_science_fiction", "genre_horror", "genre_drama", "genre_carousel_productions", "genre_rogue_state", "genre_the_cartel", "genre_animation", "genre_romance", "genre_western", "genre_aniplex", "genre_history", "genre_brosta_tv", "genre_tv_movie", "genre_odyssey_media", "genre_music")

CSV_FILE_PATH <-  "/Users/nickhilsethi/src/stat706-class-materials/final-project/terraform/project-infra/project_data.csv"

```
# TODO
- Run plots of relevant variables against revenue. covariance matrix of genres.
- Run regression using step function AIC information criterion. Identify meaningful values using  p-values.
- Discuss the results. Run diagnostics, were the assumptions of LR correct?
- Prediction intervals

# Introduction
Profitability has become a contentious subject in the Film industry in recent years. The highest grossing films are typically either remakes of one kind or another (e.g. Marvel, Star Wars), or very small-budget independent films that receive high critical praise (e.g. Moonlight, Birdman, etc.). Acclaimed director G. Inarritu compared the issue to the polarization of the global economy, vis a vis the "99% and the 1%" (https://youtu.be/SQ7qKKQrSBY).

The goal of this paper is to investigate predictors of profitability, defined as `revenue - budget` (note, we assume films use all of their budget -- no more, no less). In particular, we consider the following variables:

- Release date. This allows us capture some kind of time-trend in profitability
- Budget. This captures the constraint that movies must be generally profitable. 
- Genre. This captures popularity effects by genre.
- Rating. This captures the "quality" of the film.

The dataset used here is Kaggle"s "The Movies Dataset", located here https://www.kaggle.com/rounakbanik/the-movies-dataset. The dataset is an aggregate of data from GroupLens and TMDB.

# Methods

## Data
The two relevant tables and columns from the Movies dataset are `movies_metadata.csv` and `ratings.csv`, which have the following schemas, respectively:

```
MOVIES_METADATA {
  genres: [{ genreId: <int>,  name: <str>}],
  revenue: float,
  budged: float,
  imdbId: int
}

RATINGS {
  movieId: int,
  userId: int,
  rating: float,
}

LINKS {
  movieId: int,
  imdbId: int
}
```

Some preparation was needed to turn the Movies data into a usable format. First, the genre column of movies_metadata.csv is JSON, encoded as a list of pairs e.g. `[{genreId: 1, genreName: Action}, {genreId: 2, genreName: Comedy}]`. I obtained the set of unique genres named in the dataset, and added one boolean column for every genre found. 

Second, the `ratings` table contains movie ratings at the level of `(movieId, userId)` pairs; a groupby operation was performed to extract the average rating for each movie. This table contained about 26 million rows, and the grouping operation was very expensive, taking roughly ~1 minute.

Finally, a join was performed between the two tables using the join table `links.csv`. 26 Million ratings and 5 Thousand movies. 

Given the computationally expensive nature of the above transformations and the need to be able to "start fresh" i.e. recover from potential data corruption, I conducted the data transformation and resampling on AWS servers. See terraform code in this repository which sets up a postgresql database and a single server on AWS to store and manipulate this data.

### Columns
The final schema is as described below. Genres are represented as `boolean` columns with names `genre_[name]`; the prefix of "genre_" helps to avoid unfortunate name conflicts with keywords in postgres and python e.g. foreign (as in foreign key). `profit` was derived from this dataset by computing the quantity `revenue - budget` for each row in the dataframe.

```
PROJECT_DATA {
  imdb_id: int,
  revenue: float,
  budget: float,
  profit: float,
  genre_action: boolean,
  ...
  [many genre columns here]
  ...
  genre_music: boolean
}
```

The dataframe contains about `30615` rows. Computing high-dimensional regressions on this dataset was very computational expensive, so I sub-sampled 10% of the data at random.
```{r}
df <- read.csv(file = CSV_FILE_PATH, header = TRUE, sep = ",")

# number of rows
nrow(df)

project_data <- df[sample(nrow(df), nrow(df) / 10), ]
for (col in GENRE_COLUMNS) {
  project_data[col] <- lapply(project_data[col], as.logical)
}

project_data$profit <- project_data$revenue - project_data$budget
```
```{r}
ggplot(project_data, aes(x=profit)) + geom_histogram()
ggplot(project_data, aes(x=budget, y=profit)) + geom_point()
```
Ratings appear to have some effect on profitability, but as we can clearly see.
```{r}
ggplot(project_data, aes(x=average_rating, y=profit)) + geom_point()
```

Interestingly, release date appears to have no relationship with profit, so we leave this out of the model below.
```{r}
ggplot(project_data, aes(x=release_date, y=profit)) + geom_point()
```

## Model

```{r}
lmod <- lm(profit ~ budget + average_rating + genre_vision_view_entertainment + genre_thriller + genre_pulser_productions + genre_war + genre_fantasy + genre_documentary + genre_sentai_filmworks + genre_gohands + genre_action + genre_mardock_scramble_production_committee + genre_family + genre_crime + genre_comedy + genre_foreign + genre_adventure + genre_telescene_film_group_productions + genre_mystery + genre_science_fiction + genre_horror + genre_drama + genre_carousel_productions + genre_rogue_state + genre_the_cartel + genre_animation + genre_romance + genre_western + genre_aniplex + genre_history + genre_brosta_tv + genre_tv_movie + genre_odyssey_media + genre_music, data = project_data)
step(lmod)
```
