---
title: "Stat 706 Final Project: Investigating Predictors of Movie Profitability"
subtitle: Nickhil Sethi
output:
  pdf_document: default
  word_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(ggplot2)
library(dplyr)

# global variable, don't want to echo this
GENRE_COLUMNS <- c("genre_vision_view_entertainment", "genre_thriller", "genre_pulser_productions", "genre_war", "genre_fantasy", "genre_documentary", "genre_sentai_filmworks", "genre_gohands", "genre_action", "genre_mardock_scramble_production_committee", "genre_family", "genre_crime", "genre_comedy", "genre_foreign", "genre_adventure", "genre_telescene_film_group_productions", "genre_mystery", "genre_science_fiction", "genre_horror", "genre_drama", "genre_carousel_productions", "genre_rogue_state", "genre_the_cartel", "genre_animation", "genre_romance", "genre_western", "genre_aniplex", "genre_history", "genre_brosta_tv", "genre_tv_movie", "genre_odyssey_media", "genre_music")

CSV_FILE_PATH <-  "/Users/nickhilsethi/src/stat706-class-materials/final-project/terraform/project-infra/project_data.csv"

```
# TODO
- Run plots of relevant variables against revenue. covariance matrix of genres.
- Run regression using step function AIC information criterion. Identify meaningful values using  p-values.
- Discuss the results. Run diagnostics, were the assumptions of LR correct?
- Prediction intervals

# Introduction
Profitability has become a contentious subject in the Film industry in recent years. The highest grossing films are typically either remakes of one kind or another (e.g. Marvel, Star Wars), or very small-budget independent films that receive high critical praise (e.g. Moonlight, Birdman, etc.). Acclaimed director G. Inarritu compared the issue to the polarization of the global economy, vis a vis the "99% and the 1%" (https://youtu.be/SQ7qKKQrSBY).

The goal of this paper is to investigate predictors of profitability, defined as `revenue - budget` (note, we assume films use all of their budget -- no more, no less). In particular, we consider the following variables:

- Release date. This allows us capture some kind of time-trend in profitability
- Budget. This captures the constraint that movies must be generally profitable. 
- Genre. This captures popularity effects by genre.
- Rating. This captures the "quality" of the film.

The dataset used here is Kaggle"s "The Movies Dataset", located here https://www.kaggle.com/rounakbanik/the-movies-dataset. The dataset is an aggregate of data from GroupLens and TMDB.

# Methods

## Data
The two relevant tables and columns from the Movies dataset are `movies_metadata.csv` and `ratings.csv`, which have the following schemas, respectively:

```
MOVIES_METADATA {
  genres: [{ genreId: <int>,  name: <str>}],
  revenue: float,
  budged: float,
  imdbId: int
}

RATINGS {
  movieId: int,
  userId: int,
  rating: float,
}

LINKS {
  movieId: int,
  imdbId: int
}
```

Some preparation was needed to turn the Movies data into a usable format. The genre column of movies_metadata.csv is JSON, encoded as a list of pairs representing the set of genres the film is associated with e.g. `[{genreId: 1, genreName: Action}, {genreId: 2, genreName: Comedy}]`; this column was converted to a boolean array with one index for each genre .

The `ratings` table contains movie ratings at the level of `(movieId, userId)` pairs; a grouping operation was performed to extract the average rating for each movie. Finally, a join was performed between the two tables using the join table `LINKS`. 

The final schema is as described below. The final schema contains `length(GENRE_COLUMNS)` genres. `genre_[name]`; the prefix of "genre_" helps to avoid unfortunate name conflicts with keywords in postgres and python e.g. foreign (as in foreign key). `profit` was derived from this dataset by computing the quantity `revenue - budget` for each row in the dataframe.

```
movies {
  imdb_id: int,
  revenue: float,
  budget: float,
  profit: float,
  release_date: date,
  genre_action: boolean,
  genre_thriller: boolean,
  ...
  genre_music: boolean
}
```
### General Characteristics and Distribution

At the outset, the dataframe contains about `30615` rows; a few basic transformations are performed to cast data to the correct types, and compute the `profit` column. Finally, incomplete cases are dropped.

```{r}
movies <- read.csv(file = CSV_FILE_PATH, header = TRUE, sep = ",")

# compute profits for each film
movies$profit <- movies$revenue - movies$budget

# cast the release_date field to a date type
movies$release_date <- as.Date(movies$release_date)

# cast genre columns to boolean
for (col in GENRE_COLUMNS) {
  movies[col] <- lapply(movies[col], as.logical)
}

# check if completeness is 
movies$is_complete <- complete.cases(movies)
ggplot(movies, aes(x=is_complete, y=profit)) + geom_jitter(width = .05, height=.05) + geom_point()

# confirm that NA is not correlated with revenue
movies <- movies[complete.cases(movies), ]

# subsample 20% of the data
movies <- movies[sample(nrow(movies), nrow(movies) / 2), ]
```


```{r}
ggplot(movies, aes(x=profit)) + geom_histogram()
ggplot(movies, aes(x=budget, y=profit)) + geom_point()
```
Ratings appear to have some effect on profitability, but as we can clearly see the relationship is non-linear:
```{r}
ggplot(movies, aes(x=average_rating, y=profit)) + geom_point()
```


Release date has an interesting relationship with profit;
```{r}
ggplot(movies, aes(x=release_date, y=profit)) + geom_point()
```

## Model

```{r}
lmod <- lm(profit ~ budget + average_rating + release_date + genre_vision_view_entertainment + genre_thriller + genre_pulser_productions + genre_war + genre_fantasy + genre_documentary + genre_sentai_filmworks + genre_gohands + genre_action + genre_mardock_scramble_production_committee + genre_family + genre_crime + genre_comedy + genre_foreign + genre_adventure + genre_telescene_film_group_productions + genre_mystery + genre_science_fiction + genre_horror + genre_drama + genre_carousel_productions + genre_rogue_state + genre_the_cartel + genre_animation + genre_romance + genre_western + genre_aniplex + genre_history + genre_brosta_tv + genre_tv_movie + genre_odyssey_media + genre_music, data = movies)
lmod_reduced <- step(lmod, echo=FALSE)
summary(lmod_reduced)
```


# Discussion

## Challenges
Not robust to re-sampling. Co-linearity
